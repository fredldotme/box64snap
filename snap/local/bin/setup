#!/bin/bash

MAGIC=":x86_64:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x3e\x00:\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/snap/bin/box64-with-gl4es.box64:"
MAGIC_FILE="/etc/binfmt.d/box64snap.conf"

if [ -f "$MAGIC_FILE" ]; then
    echo "Setup already done successfully"
    exit 0
fi

echo "$MAGIC" | sudo tee "$MAGIC_FILE" > /dev/null
SUCCESS=$?
if [ "$SUCCESS" != "0" ]; then
    echo "Failed setting up box64 binfmt handler."
    exit 1
fi

sudo systemctl restart systemd-binfmt.service
SUCCESS=$?
if [ "$SUCCESS" != "0" ]; then
    echo "Error setting up binfmt support"
    exit 1
fi

echo "Successfully set up box64 for x86_64 execution."
exit 0
